#!/bin/bash
#########################################################################################
# restore-service.sh                                                                    #
#                                                                                       #
# Optional script to run after restoring files from backup.                             #
# Use this to restore services to working state (start containers, import dbs, etc.).   #
#                                                                                       #
# Usage:                                                                                #
# - Name this file "restore-service.sh" and place in service directory                  #
# - Include it in your backup so it's available after restore                           #
# - Archiver will prompt to run it after restoration completes                          #
#                                                                                       #
# Available tools: duplicacy, docker, sqlite3, curl, wget, ssh, openssl, gpg, vim       #
# Note: Docker commands require mounting /var/run/docker.sock in compose.yaml           #
#########################################################################################

# All of the below functions are 100% optional. You can use any of these, or none. You
#   can define your own functions, and can run any command you could from a bash terminal.

# Define a function to alert the user to errors, and exit the script after alerting the user
handle_error() {
  echo "Error: ${1}"
  exit 1
}

# Define a function to determine the absolute path of the parent directory, and ensure it is
#   working in that directory, to create a consistent environment
change_to_script_directory() {
  # Get the directory where the script is located
  SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"

  # Change to the script's directory
  cd "${SCRIPT_DIR}" || handle_error "Failed to change to script directory."
}

# Define the main logical progression of this script
main() {
  # Check if Docker is available
  if ! command -v docker &> /dev/null; then
    handle_error "Docker is not installed or not in the PATH."
  fi

  # Run the above defined function to change to the directory containing this script
  change_to_script_directory

  # Pull the docker images defined in the compose.yaml file (backed up in this directory)
  echo "Pulling Docker images..."
  docker compose pull || handle_error "Failed to pull Docker images."

  # Start the docekr services defined in the compose.yaml file (backed up in this directory)
  echo "Starting Docker services..."
  docker compose up -d || handle_error "Failed to start Docker services."

  echo "Script completed successfully."
}

# Now invoke the main function defined above
main
